@{
    ViewData["Title"] = "My Orders";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Orders - Library App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(-45deg, #0d1b2a, #1b263b, #415a77, #778da9);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
        }
        @@keyframes gradient {
            0%,100%

        {
            background-position: 0% 50%
        }

        50% {
            background-position: 100% 50%
        }

        }

        .header-title {
            background: linear-gradient(135deg, #2a9d8f, #264653);
            color: white;
            padding: 3rem 1rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

            .header-title h1 {
                margin: 0;
                font-weight: 700;
                font-size: 2.5rem;
            }

            .header-title i {
                font-size: 3.5rem;
                margin-bottom: 0.5rem;
                opacity: 0.9;
            }

        .orders-container {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px;
            max-width: 1400px;
            width: 100%;
        }

        .order-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.22);
            overflow: hidden;
            transition: all 0.4s ease;
            box-shadow: 0 12px 35px rgba(0,0,0,0.35);
        }

            .order-card:hover {
                transform: translateY(-12px);
                box-shadow: 0 25px 50px rgba(42,157,143,0.6);
            }

        .order-header {
            background: linear-gradient(135deg, #264653, #2a9d8f);
            color: white;
            padding: 1.5rem;
            position: relative;
        }

       

            .order-header button {
                z-index: 10;
                transition: all 0.3s ease;
            }

                .order-header button:hover {
                    transform: translateY(-2px) scale(1.05);
                    box-shadow: 0 8px 20px rgba(220, 53, 69, 0.5) !important;
                }

        .order-body {
            padding: 2rem;
            color: white;
        }

        .order-total {
            font-size: 1.4rem;
            font-weight: 600;
            color: #a8e6cf;
        }

        .btn-login-big {
            background: linear-gradient(135deg, #2a9d8f, #264653);
            padding: 1rem 2.5rem;
            font-size: 1.3rem;
        }

            .btn-login-big:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(42,157,143,0.5);
            }

        .transition-all {
            transition: all 0.35s ease;
        }

            .transition-all:hover {
                transform: translateY(-6px) scale(1.1);
                box-shadow: 0 15px 40px rgba(42,157,143,0.6);
            }

        .shadow-2xl {
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

   
    <div class="position-fixed top-0 start-0 mt-4 ms-4 z-3">
        <a href="/Account/Categories" class="d-flex align-items-center justify-content-center text-white rounded-circle shadow-2xl transition-all"
           style="width:58px;height:58px;background:linear-gradient(135deg,#2a9d8f,#264653);border:2px solid rgba(255,255,255,0.3);backdrop-filter:blur(15px);">
            <i class="fas fa-home fs-3"></i>
        </a>
    </div>

    <div class="header-title">
        <i class="fas fa-shopping-cart"></i>
        <h1>My Orders</h1>
    </div>

    <div class="orders-container">
        <div id="ordersContent" class="orders-grid">
           
            <div class="text-center text-white">
                <div class="spinner-border" style="width:4rem;height:4rem;"></div>
                <p class="mt-4 fs-4">Loading your orders...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('jwt_token');

        if (!token) {
            document.getElementById('ordersContent').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-lock fa-6x text-warning mb-4"></i>
                    <h2 class="text-white mb-4">Please login to view your orders</h2>
                    <a href="/Account/Login" class="btn btn-success btn-lg rounded-pill px-5">
                        Login Now
                    </a>
                </div>`;
        } else {
            loadOrders();
        }

        async function loadOrders() {
            try {
                console.log("Fetching orders...");

                const response = await fetch('/api/orders', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Accept': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    alert('Session expired. Please login again.');
                    window.location.href = '/Account/Login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }

                const orders = await response.json();
                console.log("Orders received:", orders);

                const container = document.getElementById('ordersContent');
                container.innerHTML = '';

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-white py-5">
                            <i class="fas fa-shopping-cart fa-5x mb-4 opacity-50"></i>
                            <h3>No orders yet</h3>
                            <p>Start ordering your favorite books!</p>
                        </div>`;
                    return;
                }

                orders.forEach(order => {
                    let itemsHtml = '';
                    order.items.forEach(item => {
                        itemsHtml += `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-white border-opacity-10">
                                <div>
                                    <strong>${item.bookTitle || 'Unknown Book'}</strong><br>
                                    <small class="text-white-50">by ${item.bookAuthor || 'Unknown Author'}</small>
                                </div>
                                <div class="text-end">
                                    <div>${item.quantity} × $${item.unitPrice}</div>
                                    <strong class="text-success">$${item.quantity * item.unitPrice}</strong>
                                </div>
                            </div>`;
                    });

                    const card = document.createElement('div');
                    card.className = 'order-card';
                      card.innerHTML = `
            <div class="order-header position-relative pt-4 pb-3">
                <div class="d-flex justify-content-between align-items-start text-white px-3">
                    <div>
                        <div class="fw-bold fs-5">Order #${order.id}</div>
                        <small class="text-white-50">
                            ${new Date(order.orderDate).toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            })}
                        </small>
                    </div>

                    <button onclick="deleteOrder(${order.id})"
                            class="btn btn-danger rounded-pill shadow-sm d-flex align-items-center gap-1"
                            style="font-size: 0.85rem; padding: 0.4rem 0.9rem; z-index: 10;"
                            title="Delete this order">
                        <i class="fas fa-trash-alt"></i>
                        <span class="d-none d-sm-inline">Delete</span>
                    </button>
                </div>
            </div>

            <div class="order-body px-4 pb-4">
                ${itemsHtml}
                <div class="text-end mt-4 pt-3 border-top border-white border-opacity-20">
                    <strong class="fs-4 text-success">Total: $${order.totalPrice}</strong>
                </div>
            </div>
        `;
                    container.appendChild(card);
                });

            } catch (err) {
                console.error("Error loading orders:", err);
                document.getElementById('ordersContent').innerHTML = `
                    <div class="text-center text-danger py-5">
                        <h3>Failed to load orders</h3>
                        <p>Open Console (F12) for details</p>
                    </div>`;
            }
        }
                
        async function deleteOrder(orderId) {
            if (!confirm("Are you sure you want to delete this order? This action cannot be undone.")) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok || response.status === 204) {
                    alert("Order deleted successfully!");
                    loadOrders(); 
                } else {
                    alert("Failed to delete order. Try again.");
                }
            } catch (err) {
                console.error("Delete error:", err);
                alert("Connection error. Check your internet.");
            }
        }
    </script>
</body>
</html>
